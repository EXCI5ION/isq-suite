name: Build Suite with PyInstaller

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller pillow

    - name: Build Windows applications (onedir)
      run: |
        # Construir cada aplicación con su propia carpeta
        pyinstaller --onedir --name ISQ_Suite `
          --icon resources/icons/ISQ.ico `
          --add-data "resources;resources" `
          --add-data "src;src" `
          --add-data "scripts;scripts" `
          --hidden-import "src.suite.core" `
          --hidden-import "src.suite.gui" `
          src/suite/launcher.py
        
        pyinstaller --onedir --name iNMR `
          --icon resources/icons/iNMR.ico `
          --add-data "resources;resources" `
          --add-data "src;src" `
          --add-data "scripts;scripts" `
          --hidden-import "src.suite.core" `
          --hidden-import "src.suite.gui" `
          src/suite/apps/inmr/maini.py
        
        pyinstaller --onedir --name qNMR `
          --icon resources/icons/qNMR.ico `
          --add-data "resources;resources" `
          --add-data "src;src" `
          --add-data "scripts;scripts" `
          --hidden-import "src.suite.core" `
          --hidden-import "src.suite.gui" `
          src/suite/apps/qnmr/mainq.py
        
        pyinstaller --onedir --name sNMR `
          --icon resources/icons/sNMR.ico `
          --add-data "resources;resources" `
          --add-data "src;src" `
          --add-data "scripts;scripts" `
          --hidden-import "src.suite.core" `
          --hidden-import "src.suite.gui" `
          src/suite/apps/snmr/mains.py

    - name: Install Inno Setup
      uses: InnoSetup/setup-innosetup@v1
      with:
        version: '6.2.0'

    - name: Create installer script
      run: |
        # Crear script ISS para Inno Setup
        $issContent = @"
        [Setup]
        AppName=ISQ Suite
        AppVersion=1.0.0
        AppPublisher=EXCI5ION
        DefaultDirName={autopf}\ISQ Suite
        DefaultGroupName=ISQ Suite
        OutputBaseFilename=ISQ_Suite_Installer
        SetupIconFile=resources\icons\ISQ.ico
        Compression=lzma2
        SolidCompression=yes
        OutputDir=dist

        [Files]
        ; Suite principal
        Source: "dist\ISQ_Suite\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs
        
        ; Aplicaciones individuales
        Source: "dist\iNMR\*"; DestDir: "{app}\iNMR"; Flags: ignoreversion recursesubdirs
        Source: "dist\qNMR\*"; DestDir: "{app}\qNMR"; Flags: ignoreversion recursesubdirs
        Source: "dist\sNMR\*"; DestDir: "{app}\sNMR"; Flags: ignoreversion recursesubdirs

        [Icons]
        ; Accesos directos para la suite
        Name: "{group}\ISQ Suite"; Filename: "{app}\ISQ_Suite.exe"; IconFilename: "{app}\resources\icons\ISQ.ico"
        Name: "{commondesktop}\ISQ Suite"; Filename: "{app}\ISQ_Suite.exe"; IconFilename: "{app}\resources\icons\ISQ.ico"
        
        ; Accesos directos para aplicaciones individuales
        Name: "{group}\iNMR"; Filename: "{app}\iNMR\iNMR.exe"; IconFilename: "{app}\iNMR\resources\icons\iNMR.ico"
        Name: "{group}\qNMR"; Filename: "{app}\qNMR\qNMR.exe"; IconFilename: "{app}\qNMR\resources\icons\qNMR.ico"
        Name: "{group}\sNMR"; Filename: "{app}\sNMR\sNMR.exe"; IconFilename: "{app}\sNMR\resources\icons\sNMR.ico"
        "@
        Set-Content -Path "installer.iss" -Value $issContent

    - name: Compile installer
      run: iscc installer.iss

    - name: Upload Windows installer
      uses: actions/upload-artifact@v4
      with:
        name: ISQ_Suite_Windows
        path: dist/ISQ_Suite_Installer.exe

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y binutils libgl1-mesa-dev

    - name: Install Python dependencies
      run: |
        pip install -r requirements.txt
        pip install pyinstaller pillow

    - name: Build Linux applications (onedir)
      run: |
        pyinstaller --onedir --name ISQ_Suite \
          --icon resources/icons/ISQ.ico \
          --add-data "resources:resources" \
          --add-data "src:src" \
          --add-data "scripts:scripts" \
          --hidden-import "src.suite.core" \
          --hidden-import "src.suite.gui" \
          src/suite/launcher.py
        
        pyinstaller --onedir --name iNMR \
          --icon resources/icons/iNMR.ico \
          --add-data "resources:resources" \
          --add-data "src:src" \
          --add-data "scripts:scripts" \
          --hidden-import "src.suite.core" \
          --hidden-import "src.suite.gui" \
          src/suite/apps/inmr/maini.py
        
        pyinstaller --onedir --name qNMR \
          --icon resources/icons/qNMR.ico \
          --add-data "resources:resources" \
          --add-data "src:src" \
          --add-data "scripts:scripts" \
          --hidden-import "src.suite.core" \
          --hidden-import "src.suite.gui" \
          src/suite/apps/qnmr/mainq.py
        
        pyinstaller --onedir --name sNMR \
          --icon resources/icons/sNMR.ico \
          --add-data "resources:resources" \
          --add-data "src:src" \
          --add-data "scripts:scripts" \
          --hidden-import "src.suite.core" \
          --hidden-import "src.suite.gui" \
          src/suite/apps/snmr/mains.py

    - name: Package Linux distribution
      run: |
        # Crear estructura de directorios para el paquete
        mkdir -p isq_suite_linux
        mkdir -p isq_suite_linux/ISQ_Suite
        mkdir -p isq_suite_linux/iNMR
        mkdir -p isq_suite_linux/qNMR
        mkdir -p isq_suite_linux/sNMR
        
        # Copiar aplicaciones
        cp -r dist/ISQ_Suite/* isq_suite_linux/ISQ_Suite/
        cp -r dist/iNMR/* isq_suite_linux/iNMR/
        cp -r dist/qNMR/* isq_suite_linux/qNMR/
        cp -r dist/sNMR/* isq_suite_linux/sNMR/
        
        # Crear script de instalación
        cat > isq_suite_linux/install.sh <<'EOL'
        #!/bin/bash
        
        # Verificar permisos de administrador
        if [ "$(id -u)" -ne 0 ]; then
            echo "Por favor ejecute este script como root o con sudo"
            exit 1
        fi
        
        INSTALL_DIR="/opt/isq_suite"
        
        # Crear directorio de instalación
        mkdir -p "$INSTALL_DIR"
        
        # Copiar archivos
        cp -r ISQ_Suite "$INSTALL_DIR/"
        cp -r iNMR "$INSTALL_DIR/"
        cp -r qNMR "$INSTALL_DIR/"
        cp -r sNMR "$INSTALL_DIR/"
        
        # Crear accesos directos para todas las aplicaciones
        for app in ISQ_Suite iNMR qNMR sNMR; do
            app_name=$(basename "$app")
            cat > "/usr/share/applications/$app_name.desktop" <<DESKTOP
            [Desktop Entry]
            Name=$app_name
            Exec=$INSTALL_DIR/$app_name/$app_name
            Icon=$INSTALL_DIR/$app_name/resources/icons/${app_name}.ico
            Terminal=false
            Type=Application
            Categories=Science;
            DESKTOP
        done
        
        echo "Instalación completada en $INSTALL_DIR"
        EOL
        
        chmod +x isq_suite_linux/install.sh
        tar czvf ISQ_Suite_Linux.tar.gz isq_suite_linux

    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: ISQ_Suite_Linux
        path: ISQ_Suite_Linux.tar.gz

  build-macos:
    runs-on: macos-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pyinstaller pillow

    - name: Build macOS applications (onedir)
      run: |
        # Construir cada aplicación con su propia carpeta
        pyinstaller --onedir --name "ISQ Suite" \
          --icon resources/icons/ISQ.ico \
          --add-data "resources:resources" \
          --add-data "src:src" \
          --add-data "scripts:scripts" \
          --hidden-import "src.suite.core" \
          --hidden-import "src.suite.gui" \
          src/suite/launcher.py
        
        pyinstaller --onedir --name "iNMR" \
          --icon resources/icons/iNMR.ico \
          --add-data "resources:resources" \
          --add-data "src:src" \
          --add-data "scripts:scripts" \
          --hidden-import "src.suite.core" \
          --hidden-import "src.suite.gui" \
          src/suite/apps/inmr/maini.py
        
        pyinstaller --onedir --name "qNMR" \
          --icon resources/icons/qNMR.ico \
          --add-data "resources:resources" \
          --add-data "src:src" \
          --add-data "scripts:scripts" \
          --hidden-import "src.suite.core" \
          --hidden-import "src.suite.gui" \
          src/suite/apps/qnmr/mainq.py
        
        pyinstaller --onedir --name "sNMR" \
          --icon resources/icons/sNMR.ico \
          --add-data "resources:resources" \
          --add-data "src:src" \
          --add-data "scripts:scripts" \
          --hidden-import "src.suite.core" \
          --hidden-import "src.suite.gui" \
          src/suite/apps/snmr/mains.py

    - name: Create DMG installer
      run: |
        # Crear estructura de directorios
        mkdir ISQ_Suite_Installation
        mv dist/"ISQ Suite" ISQ_Suite_Installation/
        mv dist/"iNMR" ISQ_Suite_Installation/
        mv dist/"qNMR" ISQ_Suite_Installation/
        mv dist/"sNMR" ISQ_Suite_Installation/
        
        # Crear acceso directo a Aplicaciones
        ln -s /Applications ISQ_Suite_Installation/Applications
        
        # Crear DMG
        hdiutil create -volname "ISQ Suite" \
          -srcfolder ISQ_Suite_Installation \
          -ov -format UDZO \
          -fs HFS+ \
          -imagekey zlib-level=9 \
          ISQ_Suite.dmg

    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: ISQ_Suite_macOS
        path: ISQ_Suite.dmg
